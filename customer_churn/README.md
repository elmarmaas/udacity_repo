# Predict Customer Churn

Project **Predict Customer Churn** of ML DevOps Engineer Nanodegree by Udacity

## Project Description
The churn_library.py is a library of functions to find customers,
who are likely to churn. 
If run as a whole script, it reads customer data from a csv file 
named bank_data.csv in sub-folder data.
It performs exploratory data analysis (EDA),
encodes categorical variables, performs feature engineering, trains
machine learning models (logistic regression and random forest),
evaluates the models, creates explanability plots using SHAP values
and saves the models to disk.
Processing is completed by providing features importance plots
and ROC curves, for assisting in estimating future customer churn.
Each function is documented with input and output specifications.

## Files and data description
| File / Folder                    | Purpose                                           |
|----------------------------------|---------------------------------------------------|
| README.md                        | This file containing decription of the project    |
| churn_library.py                 | Python library containing the projects functions  |
| churn_script_logging_and_test.py | Test script for all functions in churn_library.py |
| churn_notebook.ipynb             | Concept for the library                           |
| Guide.ipynb                      | Task description by Udacity for this exercise     |
| sequencediagram.jpeg             | Sequence diagram showing the function call hiearchy of the lib | 
| data                             | Folder containing input data bank_data.csv        |
| images                           | Folder containing generated images (empty when the lib or testing has not been executed)               |
| logs                             | Folder containing generated logs (empty when the lib or testing has not been executed)                 |
| samples                          | Folder containing data generated by a final test run before submission of the solution |
| churnenv                         | Folder generated by env setup (see below)         | 

## Running Files
How do you run your files? What should happen when you run your files?
### Environment Setup
Before running  the library code please make sure you have setup the environment
correctly. The library has been developed with python 3.12 and uses several
libraries. It is recommended to setup a virtual environment. This can be done 
in the following way:
Create python virtual environment:
```bash
python3 -m venv churnenv
```
This will create a folder named churnenv. You can now start a virtual environment
by sourcing the activate script from the bin subfolder.
Start virtual environment:

```bash
source churnenv/bin/activate
```
Inside the virtual environment you should install required packages 
as defined in the requirements.txt file: 
```bash
pip install -r requirements.txt
```
Please note that the installtion is only necessary once. After inital 
setup and installation the packages will be available in the virtual 
environment.
Once the environment setup is complete the library code can be executed.

### Running the main library
The main library can be run this way:
```bash
python3 churn_library.py
```
This will execute the churn predition and store generated images in a subfolder
named images. It will also provide logs that can be found in subfolder logs.

The following output will be generated:
| Filename  | Content |
| ----------|---------|
| logs/churn_eda.log | Textual results from exploratory data analysis on input data | 
| logs/churn_library.log | Logging output from the main script - please check  inside this file for warning and errors! |
|  |  |
| images/eda/churn_distribution.png | Visualization of churn in the database used |
| images/eda/customer_age_distribution.png | Distribution of customer age in the database |
| images/eda/customer_marital_status_distribution.png   | Distribution of marital status in the database |
| images/eda/feature_correlation_heatmap.png | Heatmap diagram showing the correlation of features in the input dataset |
| images/eda/total_transition_distribution.png | Transition distribution |
| images/results/feature_importance_plot.png | Main result showing which feature has most impact on customer churn |
| images/results/feature_shap_explanation.png | SHAP Diagram (SHapley Additive exPlanations) - can be used to better understand the output of the model |
| images/results/logistic_regression_classifier_report.png | Report for the Logistic Regression model |
| images/results/random_forest_classifier_report.png | Report for the Random Forest Classifier model|
| images/results/roc_curves_comparison.png | ROC (Receiver Operating Charcateristic) curves showing the quality of the two different models used in the lib (Random Forest and Logistic Regression). The bigger the AUC (Area Under the Curve) the better the model is as it makes better predictions. |


### Testing the library

For all testing scenarios a testing log file will be created in the logs 
folder with a timestamp in its name:
`logs/churn_library_test_pytest_session_YYYYMMDD_HHMMSS.log`

Testing the entire library can be done by running:
```bash
pytest churn_script_logging_and_tests.py
```
Please be aware that ***running the entire test suite will take approximately 
13 Minutes on an AMD Ryzen 7 PRO 7840 (no GPU usage)***


Enabling verbose output can be done by using the -v flag:
```bash
pytest churn_script_logging_and_tests.py -v
```

Running specific tests can be done by specifying the test explicitly:
```bash
pytest churn_script_logging_and_tests.py::test_import -v
```

Running specific tests with detailed debug information:
```bash
pytest churn_script_logging_and_tests.py::test_classification_report_image -v -s --log-cli-level=DEBUG
```

The above commands report the testing results on the commandline. 
If you want the pytest output to be logged into a file for documenting test
execution you can redirect the output in the following way (bash syntax):
```bash
pytest churn_script_logging_and_tests.py -v 2>&1 | tee logs/pytest_results.log
```
